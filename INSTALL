This file documents installation and compilation process of ucollect on clean
linux operating system.

In the tutorial there is clean installation of Debian. In the other
distributions should be names of packages similar.

Build options are customized to installation on the developer's station.

Our projects are compiled with flag NO_DOC=1. If you want documentation you
have to run 'apt-get install asciidoc' command first. Note: 'asciidoc' includes
latex therefore about 700MB of dependencies.

Ucollect client
===============

1) Install developmnet tools
----------------------------

apt-get install gcc g++ git qt4-qmake pkg-config cmake

2) Install ucollect dependencies
--------------------------------

apt-get install zlib1g-dev libpcap-dev libqt4-dev python-dev socat

3) Build the rest of dependencies from source code
--------------------------------------------------

Not all of ucollect's dependencies are packaged in distributions. This projects
are necessary too:

3.A) libuci
-----------

Libuci is project from the authors of OpenWrt. It is library for manipulation
with UCI configuration files.

Clone repository with libuci:
	git clone git://nbd.name/uci.git

Checkout latest working(!) version:
	git checkout v0.8.0

Build and install:
	cmake -D BUILD_LUA:BOOL=OFF .
	make
	make install

3.B) libatsha204
----------------

Libatsha204 is library for communication with Atmel ATSHA204 crypto chip. This
library supports several ways how the chip could be installed. Native I2C
driver of Linux kernel, some USB sticks and SW emulation of chip features are
supported.

This tutorial is primary targeted to installation ucollect on the developer's
station so we will use the SW emulation of the chip.

Install some specific libatsha204 dependencies:
	apt-get install libunbound-dev libssl-dev

Clone repository with libatsha204:
	git clone https://gitlab.labs.nic.cz/turris/libatsha204.git

Libatsha204 uses our own build system that is included as a git submodule:
	git submodule init
	git submodule update

Build and install libtsha204 with emulation layer:
	make USE_LAYER=USE_LAYER_EMULATION NO_DOC=1 CONFIG_PATH="/etc/atsha204.sw"
	make install

Note: For another layers you have to own some device with Atmel ATSHA204 crypto
chip.

Copy configuration file to expected location:
	cp atsha204.sw /etc/.

Note: Configuration file describes content of internal ATSHA204 memory. Not all
of memory slots are needed or valid.

4) Build ucollect
-----------------

Clone repository with ucollect:
	git clone https://gitlab.labs.nic.cz/turris/ucollect.git

Ucollect uses our own build system that is included as a git submodule:
	git submodule init
	git submodule update

Build:
	make NO_DOC=1

There is no "install" target in Makefile. You can inspire in ucollect-*
packages in our openwrt repository.

Ucollect server
===============

1) Install developmnet tools
----------------------------

apt-get install gcc g++ git qt4-qmake pkg-config

2) Install ucollect server dependencies
---------------------------------------

apt-get install zlib1g-dev libqt4-dev

3) Build the rest of dependencies from source code
--------------------------------------------------

Build and install(!) libatsha204 as is described in Ucollect client, part 3.B.

No, install additional dependency:
	apt-get install python-dev

Go to subdirectory src/python and run commands:
	make NO_DOC=1 USE_LAYER=USE_LAYER_EMULATION PYTHON=1
	python setup.py install

4) Build soxy
-------------

Clone repository with ucollect:
	git clone https://gitlab.labs.nic.cz/turris/ucollect.git

Go to subdirectory src/master/soxy and build it:
	qmake
	make

5) Install necessary python packages:
	apt-get install python-twisted python-pygresql python-dateutil

Setup ucollect client and server communication and environment
==============================================================

1) Environment requirements
---------------------------

There is one unusual requirement. Ucollect is using libatsha204 and ATSHA204
crypto-chip to authentication. ATSHA204 has 16 key slots and is neccessary to
pick one. ID of slot is combination of one record in chip's OTP memory and one
TXT record in specific DNS zone.

me of TXT DNS record is defined in libatsha204 repository in
src/libatsha204/configuration.h file. You're looking for
DEFAULT_DNS_RECORD_FIND_KEY constant.

Theoretically, for development purposes, you can use our DNS record. For
production environment you need zone that is signed with DNSSEC. Libatsha204
checks validity of DNS signature and checks if signature exists.

2) SSL certificate
------------------

Communication between client and server is naturally encrypted. Identities are
checked with SSL certificate. Self-signed certificate is sufficient. Generate it
with command like this one:

openssl req -new -x509 -keyout /etc/ucollect-dev.pem -out /etc/ucollect-dev.pem -days 1825 -nodes -subj "/C=CZ/ST=Prague/L=Prague/O=Ucollect"

3) Configure server
-------------------

Ucollect server uses PostgreSQL as backend. So, install PostgreSQL:
	apt-get install postgresql

Log-in as postgres user and create users for ucollect server. No user needs to
be supersuser. You can answer "no" to all questions.
	root@ucollect-server:~# su postgres 
	postgres@ucollect-server:/root$ cd
	postgres@ucollect-server:~$ createdb ucollect
	postgres@ucollect-server:~$ createuser ucollect
	postgres@ucollect-server:~$ createuser authenticator
	postgres@ucollect-server:~$ createuser updater
	postgres@ucollect-server:~$ createuser jenkins
	postgres@ucollect-server:~$ createuser cleaner
	postgres@ucollect-server:~$ createuser archivist

Some users need password, some users are using system-user based authentication.
Password is necessary for: updater (set name/password in
src/master/collect-master.conf), authenticator (set name/password in
src/master/authenticator/authenticator.conf).

Anyway, on developer's station is the easiest to disable authentication. Go to
postgresql configuration directory /etc/postgresql/VERSION/main and edit file
pg_hba.conf. Set "trust" method to all authentication types. Example:

# Database administrative login by Unix domain socket
local   all             postgres                                peer

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust


Now you should be able to initialize the database. Go to src/master/dbscripts
and run:
	./initdb debug

Change setting of collect-master - at least "certificate" and "key" options.
Open  src/master/collect-master.conf and change these:
	; The SSL certificate
	cert = /etc/ucollect-dev.pem
	key = /etc/ucollect-dev.pem

Run authenticator:
	cd src/master/authenticator
	./authenticator.py authenticator.conf

Run ucollect server:
	cd src/master
	./collect-master.py collect-master.conf

4) Configure client
-------------------

Get root trust anchor for unbound/libunbound:
	apt-get install unbound-anchor
	mkdir /etc/unbound
	unbound-anchor -u http://data.iana.org -x /root-anchors/root-anchors.xml -v

Create configuration for ucollect client:
	mkdir /etc/config
	vim /etc/config/ucollect

Example config:
--------------------------------------------------
config interface
	option ifname 'eth0'

config uplink
	option name localhost
	option service 5679
	option cert "/etc/ucollect-dev.pem"

config plugin
	option libname 'libplugin_count.so'

config plugin
	option libname 'libplugin_bandwidth.so'

config plugin
	option libname 'libplugin_buckets.so'
--------------------------------------------------

And run ucollect client:
	./bin/ucollect
